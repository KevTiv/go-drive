apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: go-drive
data:
  01-init.sql: |
    -- Database initialization script for go-drive
    -- PostgreSQL 16 with Row Level Security (RLS)

    -- Enable required extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    -- Create service roles for microservices
    DO $$
    BEGIN
      -- User Service Role
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'user_service') THEN
        CREATE ROLE user_service WITH LOGIN PASSWORD 'user_service_password';
      END IF;

      -- File Service Role (for future use)
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'file_service') THEN
        CREATE ROLE file_service WITH LOGIN PASSWORD 'file_service_password';
      END IF;

      -- Read-only analytics role (for future use)
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'analytics_reader') THEN
        CREATE ROLE analytics_reader WITH LOGIN PASSWORD 'analytics_password';
      END IF;
    END
    $$;

    -- Users table
    CREATE TABLE IF NOT EXISTS users (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        firstname VARCHAR(100) NOT NULL,
        surname VARCHAR(100) NOT NULL,
        email VARCHAR(255) UNIQUE NOT NULL,
        phone VARCHAR(50),
        country VARCHAR(100) DEFAULT 'The netherlands',
        region VARCHAR(100),
        city VARCHAR(100),
        type VARCHAR(50) DEFAULT 'standard',
        email_verified BOOLEAN DEFAULT FALSE,
        is_active BOOLEAN DEFAULT TRUE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        deleted_at TIMESTAMP WITH TIME ZONE,
        CONSTRAINT email_format CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
    );

    -- Create indexes for better query performance
    CREATE INDEX IF NOT EXISTS idx_users_email ON users(email) WHERE deleted_at IS NULL;
    CREATE INDEX IF NOT EXISTS idx_users_is_active ON users(is_active) WHERE deleted_at IS NULL;
    CREATE INDEX IF NOT EXISTS idx_users_type ON users(type) WHERE deleted_at IS NULL;
    CREATE INDEX IF NOT EXISTS idx_users_created_at ON users(created_at DESC) WHERE deleted_at IS NULL;
    CREATE INDEX IF NOT EXISTS idx_users_deleted_at ON users(deleted_at) WHERE deleted_at IS NOT NULL;

    -- Files table (for future file service)
    CREATE TABLE IF NOT EXISTS files (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        name VARCHAR(255) NOT NULL,
        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        folder_id UUID,
        size BIGINT NOT NULL,
        mime_type VARCHAR(100),
        storage_key VARCHAR(500) NOT NULL,
        checksum VARCHAR(64),
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        deleted_at TIMESTAMP WITH TIME ZONE,
        CONSTRAINT positive_size CHECK (size >= 0)
    );

    CREATE INDEX IF NOT EXISTS idx_files_user_id ON files(user_id) WHERE deleted_at IS NULL;
    CREATE INDEX IF NOT EXISTS idx_files_folder_id ON files(folder_id) WHERE deleted_at IS NULL;
    CREATE INDEX IF NOT EXISTS idx_files_created_at ON files(created_at DESC) WHERE deleted_at IS NULL;

    -- Folders table (for future file service)
    CREATE TABLE IF NOT EXISTS folders (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        name VARCHAR(255) NOT NULL,
        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        parent_id UUID REFERENCES folders(id) ON DELETE CASCADE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        deleted_at TIMESTAMP WITH TIME ZONE,
        CONSTRAINT no_self_parent CHECK (id != parent_id)
    );

    CREATE INDEX IF NOT EXISTS idx_folders_user_id ON folders(user_id) WHERE deleted_at IS NULL;
    CREATE INDEX IF NOT EXISTS idx_folders_parent_id ON folders(parent_id) WHERE deleted_at IS NULL;

    -- Function to update updated_at timestamp
    CREATE OR REPLACE FUNCTION update_updated_at_column()
    RETURNS TRIGGER AS $$
    BEGIN
        NEW.updated_at = CURRENT_TIMESTAMP;
        RETURN NEW;
    END;
    $$ language 'plpgsql';

    -- Triggers to automatically update updated_at
    DROP TRIGGER IF EXISTS update_users_updated_at ON users;
    CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
        FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

    DROP TRIGGER IF EXISTS update_files_updated_at ON files;
    CREATE TRIGGER update_files_updated_at BEFORE UPDATE ON files
        FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

    DROP TRIGGER IF EXISTS update_folders_updated_at ON folders;
    CREATE TRIGGER update_folders_updated_at BEFORE UPDATE ON folders
        FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

    -- Enable Row Level Security
    ALTER TABLE users ENABLE ROW LEVEL SECURITY;
    ALTER TABLE files ENABLE ROW LEVEL SECURITY;
    ALTER TABLE folders ENABLE ROW LEVEL SECURITY;

    -- RLS Policies for users table
    -- User service can do everything with users
    CREATE POLICY user_service_all ON users
        FOR ALL
        TO user_service
        USING (true)
        WITH CHECK (true);

    -- File service can read users (to verify ownership)
    CREATE POLICY file_service_read_users ON users
        FOR SELECT
        TO file_service
        USING (true);

    -- Analytics can only read non-deleted users
    CREATE POLICY analytics_read_users ON users
        FOR SELECT
        TO analytics_reader
        USING (deleted_at IS NULL);

    -- RLS Policies for files table
    -- File service has full access
    CREATE POLICY file_service_all ON files
        FOR ALL
        TO file_service
        USING (true)
        WITH CHECK (true);

    -- User service can read files (for user data export, etc.)
    CREATE POLICY user_service_read_files ON files
        FOR SELECT
        TO user_service
        USING (true);

    -- Analytics can only read non-deleted files
    CREATE POLICY analytics_read_files ON files
        FOR SELECT
        TO analytics_reader
        USING (deleted_at IS NULL);

    -- RLS Policies for folders table
    -- File service has full access
    CREATE POLICY file_service_all ON folders
        FOR ALL
        TO file_service
        USING (true)
        WITH CHECK (true);

    -- User service can read folders
    CREATE POLICY user_service_read_folders ON folders
        FOR SELECT
        TO user_service
        USING (true);

    -- Analytics can only read non-deleted folders
    CREATE POLICY analytics_read_folders ON folders
        FOR SELECT
        TO analytics_reader
        USING (deleted_at IS NULL);

    -- Grant permissions to service roles
    GRANT CONNECT ON DATABASE postgres TO user_service, file_service, analytics_reader;

    -- User Service permissions
    GRANT SELECT, INSERT, UPDATE, DELETE ON users TO user_service;
    GRANT SELECT ON files, folders TO user_service;
    GRANT USAGE ON SCHEMA public TO user_service;

    -- File Service permissions
    GRANT SELECT, INSERT, UPDATE, DELETE ON files, folders TO file_service;
    GRANT SELECT ON users TO file_service;
    GRANT USAGE ON SCHEMA public TO file_service;

    -- Analytics Reader permissions (read-only)
    GRANT SELECT ON users, files, folders TO analytics_reader;
    GRANT USAGE ON SCHEMA public TO analytics_reader;

    -- Migrations tracking table
    CREATE TABLE IF NOT EXISTS schema_migrations (
        version VARCHAR(255) PRIMARY KEY,
        applied_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        description TEXT
    );

    -- Insert initial migration
    INSERT INTO schema_migrations (version, description)
    VALUES ('001_initial_schema', 'Initial database schema with RLS')
    ON CONFLICT (version) DO NOTHING;

    -- Insert sample data for testing (optional, comment out for production)
    INSERT INTO users (id, firstname, surname, email, phone, country, region, city, type, email_verified)
    VALUES
        ('550e8400-e29b-41d4-a716-446655440000', 'John', 'Doe', 'john.doe@example.com', '+1234567890', 'USA', 'California', 'San Francisco', 'premium', true),
        ('550e8400-e29b-41d4-a716-446655440001', 'Jane', 'Smith', 'jane.smith@example.com', '+0987654321', 'Canada', 'Ontario', 'Toronto', 'standard', false)
    ON CONFLICT (email) DO NOTHING;
